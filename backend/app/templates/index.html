<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Parking Wars at CPP!</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='styles.css') }}"
    />
  </head>
  <body>
    <div class="page">
      <div class="layout">
        <div class="sidebar">
          <h2>Account</h2>
          <form id="authForm">
            <label for="username">Username</label>
            <input id="username" name="username" autocomplete="username" />
            <label for="password">Password</label>
            <input
              id="password"
              name="password"
              type="password"
              autocomplete="current-password"
            />
            <button type="submit" id="loginBtn">Login / Register</button>
          </form>
          <button type="button" id="logoutBtn" style="display: none">
            Logout
          </button>
          <div id="currentUserDisplay" class="hint" style="display: none"></div>
          <div id="authMessage" class="hint"></div>
          <div id="vehicleSection" class="vehicle-section" style="display: none">
            <h3>Your vehicle</h3>
            <div id="vehicleOptions" class="vehicle-options"></div>
          </div>
          <div class="Description">
            <h3>Description</h3>
            <p>This is a game about parking your vehicle of choice on the grid. You can choose your vehicle from the options.</p>
          </div>
        </div>
        <div class="main">
          <h1>Parking Wars at CPP!</h1>
          <p class="hint">
            You must be logged in to toggle cars on the grid.
          </p>
          <div id="grid" class="grid"></div>
        </div>
      </div>
    </div>

    <script>
      const INITIAL_LOGGED_IN =
        "{{ 'true' if session.get('user_id') else 'false' }}" === "true";
      let isLoggedIn = INITIAL_LOGGED_IN;
      const INITIAL_USERNAME =
        {{ (current_user.username if current_user else "")|tojson }};
      let currentUsername = INITIAL_USERNAME || "";
      const VEHICLES = ["ğŸš—", "ğŸ›¸", "ğŸš€", "âœˆï¸", "ğŸš¢", "ğŸš", "ğŸš™", "ğŸš£", "ğŸš‚", "ğŸšƒ", "ğŸš†", "ğŸš‹", "ğŸšŒ", "ğŸš‘", "ğŸš’"];
      let currentVehicle = "ğŸš—";
      const POLL_INTERVAL_MS = 3000;
      let gridPollInterval = null;

      async function fetchGrid() {
        const res = await fetch("/api/v1/grid");
        if (!res.ok) {
          throw new Error("Failed to load grid");
        }
        return res.json();
      }

      async function toggleCell(index) {
        const res = await fetch("/api/v1/grid/toggle", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ index }),
        });
        if (!res.ok) {
          throw new Error("Failed to toggle cell");
        }
        return res.json();
      }

      function renderGrid(size, cells) {
        const gridElement = document.getElementById("grid");
        GRID_SIZE = size;
        if (gridElement) {
          gridElement.style.gridTemplateColumns = `repeat(${size}, 1fr)`;
        }

        const container = document.getElementById("grid");
        container.innerHTML = "";

        for (let i = 0; i < cells.length; i++) {
          const cellData = cells[i];
          const cell = document.createElement("div");
          cell.className = "cell";
          cell.textContent = cellData && cellData.vehicle ? cellData.vehicle : " ";
          cell.dataset.index = i.toString();
          container.appendChild(cell);
        }
        resizeGridToFit();
      }

      function resizeGridToFit() {
        const grid = document.getElementById("grid");
        if (!grid) return;

        const viewportWidth = window.innerWidth;
        const viewportHeight = window.innerHeight;

        const rect = grid.getBoundingClientRect();
        const spaceAbove = rect.top;
        const padding = 16;

        const maxHeightForGrid = Math.max(0, viewportHeight - spaceAbove - padding);
        const maxSize = Math.min(viewportWidth - 32, maxHeightForGrid);

        if (maxSize <= 0) return;

        const currentWidth = grid.offsetWidth || maxSize;
        const size = Math.min(currentWidth, maxSize);

        grid.style.width = `${size}px`;
      }

      function stopGridPolling() {
        if (gridPollInterval) {
          clearInterval(gridPollInterval);
          gridPollInterval = null;
        }
      }

      function startGridPolling() {
        stopGridPolling();
        gridPollInterval = setInterval(async () => {
          if (!isLoggedIn) return;
          try {
            const data = await fetchGrid();
            renderGrid(data.size, data.cells);
          } catch (_e) {}
        }, POLL_INTERVAL_MS);
      }

      function updateAuthUI() {
        const form = document.getElementById("authForm");
        const logoutBtn = document.getElementById("logoutBtn");
        const grid = document.getElementById("grid");
        const vehicleSection = document.getElementById("vehicleSection");
        const currentUserDisplay = document.getElementById("currentUserDisplay");

        if (isLoggedIn) {
          form.style.display = "none";
          logoutBtn.style.display = "inline-block";
          grid.classList.remove("grid--disabled");
          vehicleSection.style.display = "block";
          if (currentUserDisplay) {
            if (currentUsername) {
              currentUserDisplay.style.display = "block";
              currentUserDisplay.textContent = `Logged in as ${currentUsername}`;
            } else {
              currentUserDisplay.style.display = "none";
              currentUserDisplay.textContent = "";
            }
          }
          startGridPolling();
        } else {
          form.style.display = "block";
          logoutBtn.style.display = "none";
          grid.classList.add("grid--disabled");
          vehicleSection.style.display = "none";
          if (currentUserDisplay) {
            currentUserDisplay.style.display = "none";
            currentUserDisplay.textContent = "";
          }
          stopGridPolling();
        }
      }

      function renderVehicleOptions() {
        const container = document.getElementById("vehicleOptions");
        container.innerHTML = "";

        VEHICLES.forEach((emoji) => {
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className =
            "vehicle-option" +
            (emoji === currentVehicle ? " vehicle-option--selected" : "");
          btn.textContent = emoji;
          btn.addEventListener("click", async () => {
            try {
              const res = await fetch("/me/vehicle", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ vehicle: emoji }),
              });
              const data = await res.json();
              if (!res.ok) {
                return;
              }
              currentVehicle = data.vehicle || emoji;
              renderVehicleOptions();

              try {
                const gridData = await fetchGrid();
                renderGrid(gridData.size, gridData.cells);
              } catch (_e) {
                // ignore
              }
            } catch (_e) {
              // ignore
            }
          });
          container.appendChild(btn);
        });
      }

      async function handleAuthSubmit(event) {
        event.preventDefault();
        const usernameInput = document.getElementById("username");
        const passwordInput = document.getElementById("password");
        const loginBtn = document.getElementById("loginBtn");
        const authMessage = document.getElementById("authMessage");

        const username = usernameInput.value.trim();
        const password = passwordInput.value;

        if (!username || !password) {
          authMessage.textContent = "Username and password are required.";
          return;
        }

        authMessage.textContent = "";
        loginBtn.disabled = true;

        try {
          const res = await fetch("/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username, password }),
          });
          const data = await res.json();

          if (!res.ok) {
            authMessage.textContent = data.error || "Login failed.";
            return;
          }

          isLoggedIn = true;
          currentVehicle = data.vehicle || "ğŸš—";
          currentUsername = data.username || username;
          authMessage.textContent =
            data.status === "registered"
              ? "Registered and logged in."
              : "Logged in.";

          usernameInput.value = "";
          passwordInput.value = "";
          updateAuthUI();
          renderVehicleOptions();

          try {
            const gridData = await fetchGrid();
            renderGrid(gridData.size, gridData.cells);
          } catch (_e) {
            // ignore
          }
        } catch (_e) {
          authMessage.textContent = "Network error.";
        } finally {
          loginBtn.disabled = false;
        }
      }

      async function handleLogout() {
        const logoutBtn = document.getElementById("logoutBtn");
        const authMessage = document.getElementById("authMessage");
        logoutBtn.disabled = true;

        try {
          const res = await fetch("/logout", { method: "POST" });
          await res.json().catch(() => {});
        } catch (_e) {
          // ignore
        } finally {
          isLoggedIn = false;
          currentUsername = "";
          updateAuthUI();
          authMessage.textContent = "Logged out.";
          logoutBtn.disabled = false;
        }
      }

      async function loadCurrentUser() {
        if (!isLoggedIn) {
          return;
        }
        try {
          const res = await fetch("/me");
          if (!res.ok) {
            return;
          }
          const data = await res.json();
          if (data.username) {
            currentUsername = data.username;
          }
          if (data.vehicle) {
            currentVehicle = data.vehicle;
          }
          renderVehicleOptions();
          updateAuthUI();
        } catch (_e) {
          // ignore
        }
      }

      async function init() {
        try {
          const data = await fetchGrid();
          renderGrid(data.size, data.cells);
        } catch (e) {
          // Grid will stay empty if backend is unreachable.
          // Requirement says minimal UX; no extra handling here.
        }

        const container = document.getElementById("grid");
        container.addEventListener("click", async (event) => {
          if (!isLoggedIn) {
            return;
          }

          const target = event.target;
          if (!(target instanceof HTMLElement)) return;
          if (!target.classList.contains("cell")) return;

          const index = Number(target.dataset.index);
          if (!Number.isInteger(index)) return;

          try {
            await toggleCell(index);
            const data = await fetchGrid();
            renderGrid(data.size, data.cells);
          } catch (e) {
            // Ignore errors to keep behavior minimal.
          }
        });

        document
          .getElementById("authForm")
          .addEventListener("submit", handleAuthSubmit);
        document
          .getElementById("logoutBtn")
          .addEventListener("click", handleLogout);

        updateAuthUI();
        loadCurrentUser();
        window.addEventListener("resize", resizeGridToFit);
      }

      init();
    </script>
  </body>
</html>

